<html>
	<head>
		<title>Tests</title>
		<meta http-equiv="X-UA-Compatible" content="IE=9">
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	</head>
	<link rel="stylesheet" type="text/css" href="/stylesheets/catalog-style.css">
	<body>
		<div id='container-catalog'>
			<div id='wrapper-menu'>
				<div id='wrapper-objects'>
				<h2 style="text-align:center">Catálogo</h2>
					<ul id='objects'>
						Personajes
					</ul>
				</div>

				<ul id='child-objects'>
					Accesorios adicionales

				</ul>
				<ul id='textures'>
					Texturas
				</ul>
			</div>
			<div id='wrapper-canvas'>
			</div>
		</div>	
	</body>
	<script type="text/javascript">
		function loadObjects(){
			var objects=document.getElementById('objects');
			var parents=getParents();
			var liParents=[];
			for(var i=0;i<parents.parents.length;i++){
				liParents[i]=document.createElement('li');
				liParents[i].id='li_'+parents.parents[i].name;
				liParents[i].value=parents.parents[i].name;
				liParents[i].innerHTML=parents.parents[i].name;
				liParents[i].onclick=ladrar;
				objects.appendChild(liParents[i]);
			}

		}
		function loadTextures(parentName){
			var objects=document.getElementById('textures');
			var parent=getArrays(parentName);
			var textures=parent.textures;
			var liTextures=[];
			for (var i = 0; i < textures.length; i++) {
				liTextures[i]=document.createElement('li');
				liTextures[i].id=textures[i].name;
				liTextures[i].dataset.parentName;
				liTextures[i].dataset.parentName=parentName;
				liTextures[i].dataset.parentUrl;
				liTextures[i].dataset.parentUrl=parent.parent.url;
				liTextures[i].dataset.textureName;
				liTextures[i].dataset.textureName=textures[i].name;
				liTextures[i].dataset.textureUrl;
				liTextures[i].dataset.textureUrl=textures[i].url;
				liTextures[i].innerHTML=textures[i].name;
				liTextures[i].onclick=function(){drawObject(this.getAttribute('data-parent-name'),this.getAttribute('data-texture-url'),this.getAttribute('data-parent-url'))};
				objects.appendChild(liTextures[i]);
			};

		}
		function ladrar(){
			alert('guau guau')
		}
		function createCanvas(furniture){
			var wrapper=document.getElementById('wrapper-canvas');
			var parentCanvas=document.createElement('canvas');
			parentCanvas.id=furniture.parent.name;
			wrapper.appendChild(parentCanvas);
			var objects=[];
			for(var i=0;i<furniture.objects.length;i++){
				objects[i]=document.createElement('canvas');
				objects[i].id=furniture.objects[i].name;
				wrapper.appendChild(objects[i]);
			}
		}
		function getParents(){
			/**Database logic
			*
			*kawaii
			*	
			**/
			return {
				'parents':[
					{'ObjectID':'1', 'name' :'grumpy_lucy', 'url' : '/images/lucy_alpha.png' ,'barcode' : 'String', 'price': 0.00,'description':'Descripción'}
				]
			};
		}
		function getArrays(parentName){
			/**Database logic
			*
			*kawaii
			*	
			**/
			var furniture={};
			//MODO TEMPORAL

			switch(parentName){
				case 'grumpy_lucy':
					var parentArray={
						'img':{'ObjectID':'1', 'name' :'grumpy_lucy', 'url' : '/images/lucy_alpha.png' , 'z_index':0},
						'storeData':{'ObjectID':'ObjectID', 'name':'String', 'barcode' : 'String', 'price': 0.00,'description':'Descripción'}
					};
					var childsArray=[];
					var texturesArray=[	
							{'ObjectID':'ObjectID', 'name' : 'Mota', 'url': '/images/mota.jpg', 'parent' : 'grumpy_lucy'},
							{'ObjectID':'ObjectID', 'name' : 'Madera', 'url': '/images/wood.jpg', 'parent' : 'grumpy_lucy'},
							{'ObjectID':'ObjectID', 'name' : 'Piedra', 'url': '/images/stone.jpg', 'parent' : 'grumpy_lucy'},
							{'ObjectID':'ObjectID', 'name' : 'Pasto', 'url': '/images/grass.jpg', 'parent' : 'grumpy_lucy'},
							{'ObjectID':'ObjectID', 'name' : 'Flores', 'url': '/images/vintage-flowers.jpg', 'parent' : 'grumpy_lucy'}
					];
					furniture={
						'parent':{'ObjectID':parentArray.img.ObjectID,'name':parentArray.img.name, 'url':parentArray.img.url,'z_index':parentArray.img.z_index,'barcode':parentArray.storeData.barcode,'price':parentArray.img.price,'description':parentArray.storeData.description},
						'objects':childsArray,
						'textures' : texturesArray
					};
					return furniture;
					break;
			}
		}
		function drawPattern(ctx,img,x1,y1,x,y){
			var pattern=ctx.createPattern(img,'repeat');
			var pixels=[];
			ctx.rect(x1,y1,x,y);
			ctx.fillStyle=pattern;
			ctx.fill();
		};
		function scaleToCanvas(img,x,y){
			var xi=img.width;
			var yi=img.height;
			if(xi<=x){
				if(yi<=y){
					return {'width':xi,'height':yi};
				}
			}
			for(var i=Math.max(xi,yi);i>=Math.min(x,y);i--){
				xi--;
				yi--;
			}
			return {'width':xi,'height':yi};
		}
		function drawObject(canvasName,textureUrl,objectUrl){
			var imgObject={};
			var canvas=document.getElementById(canvasName);
			var ctx=canvas.getContext('2d');

			var img = new Image();
			
			img.onload=function(){
				var measures=scaleToCanvas(img,canvas.offsetWidth,canvas.offsetHeight);
				var texture=new Image();
			
				texture.onload=function(){
					drawPattern(ctx,texture,(canvas.offsetWidth/2-measures.width/2),(canvas.offsetHeight/2-measures.height/2),measures.width,measures.height);
					ctx.drawImage(img,(canvas.width-measures.width)/2,(canvas.height-measures.height)/2,measures.width,measures.height);
				};	
				texture.src=textureUrl;
			}
			img.src = objectUrl;
		}

	</script>	
	<script type="text/javascript">

		loadObjects();
		loadTextures('grumpy_lucy');

		var furniture=getArrays('grumpy_lucy');
		createCanvas(furniture);
		var wrapper=document.getElementById('wrapper-canvas');
		var canvases=wrapper.getElementsByTagName('canvas');
		for(var i=0;i<canvases.length;i++){
			canvases[i].width=wrapper.offsetWidth;
			canvases[i].height=wrapper.offsetHeight;
		}
		drawObject(furniture.parent.name,furniture.textures[4].url,furniture.parent.url);

		window.addEventListener('resize',function(){
			var furniture=getArrays('grumpy_lucy');
			var wrapper=document.getElementById('wrapper-canvas');
			var canvases=wrapper.getElementsByTagName('canvas');
			for(var i=0;i<canvases.length;i++){
				canvases[i].width=wrapper.offsetWidth;
				canvases[i].height=wrapper.offsetHeight;
			}
			drawObject(furniture.parent.name,furniture.textures[4].url,furniture.parent.url);
		});
	</script>
</html>
